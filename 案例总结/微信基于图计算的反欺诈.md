## 微信支付基于图计算的反欺诈实践

[link](https://mp.weixin.qq.com/s/molCANpMR7OY9ObEpgGx_Q)

- 三驾马车
  - 图计算引擎
  - 存储引擎(图数据库)
  - 算法设计: 针对业务去设计算法

### 图计算平台

 - Angel
 - Plato
 - **图计算平台：为什么速度是第一考虑**
   	- 图算法上限是非常高的，需要反复不断去尝试才能把它用好，因此计算速度是摆在第一位的 -> 需要反复调参

### 图数据库: 高效分析

 - 微信内部: EasyGraph, 基于S2Graph
 - TigerGraph
 - Nebula Graph

### 图算法设计

> 图算法设计方面，我们主要做了以下探索：包括团伙识别、图神经网络、传播染色、异常检测，这几类算法都是针对我们自己的业务去思考和创新的。

### 实践

#### 1. 样本增强

![image-20210823104655372](D:\笔记\案例总结\微信基于图计算的反欺诈.assets\image-20210823104655372.png)

> 但是风控场景的复杂性本身又需要大量的数据才能学习到好的模型，一个数据增强的好办法就是通过**网络关系**去实现

> 遇到样本少的情况，可以**通过复杂网络做一个”lookalike”**，找出跟样本相似的用户

#### 2. 传播染色

![image-20210823104815949](D:\笔记\案例总结\微信基于图计算的反欺诈.assets\image-20210823104815949.png)

- 最著名的传播有关算法: PageRank
- 风控场景做传播，染色扩散

> 以前反赌的同事会去赌博平台收集一些恶意的二维码，然后通过这些二维码去做传播、染色扩散，然后挖掘到更多的人和二维码，后来我们自研了一套**Personalized  PageRank**算法，对**黑灰种子用户进行扩散**，效果也非常好，大家可以在网上搜一搜这个算法。

#### 3. 基于时序的异常挖掘

![image-20210823104938634](D:\笔记\案例总结\微信基于图计算的反欺诈.assets\image-20210823104938634.png)

- 基础版: 

  - 特征值分布多样性(香农系数 > 3个标准差) + 交易异常点(HP滤波器) + 累计命中次数 = 高置信度套现用户

- 进阶版：

  - > 但HP滤波器毕竟是一种非参数方法（非参数方法在具体应用中不可避免地依赖于调节参数），如果HP滤波器过于粗糙，我们可以通过T-LSTM融合时序信息同边信息做卷积，结合ego network的概念，自研了新的算法EgoTLSTM，这样就解决了HP滤波器的问题。

#### 4. 团伙快速挖掘

![image-20210823105336929](D:\笔记\案例总结\微信基于图计算的反欺诈.assets\image-20210823105336929.png)

- 基础版: 通过网络去关联更多的用户

  - > 举个例子，我们可以针对一批高恶意样本，去挖掘他们的资金关系链，通过各种关系（资金，证件，设备，环境等）去扩散，再通过一些可信关系去做过滤，通过观察用户的资金流向，挖掘出相关的团伙和并找出涉及资金较大的头目。

- 进阶版：connected components

  - 无方向的弱的连通图: 快速把网络划分为一个个小的*连通子图*，再计算子图的*密度或者聚集系数*进行后过滤, 得到的连通子图就会是一个关系紧密的小团伙

  - 自研的TPNet这种角色识别算法： 

    > 得到团伙里面的成员构成。比如一个杀猪盘中就包括了资料组、话务组、技术组和洗钱组，可以看到团伙不仅关系紧密且分工是比较明确的。

  - 顺便补充一点，我们经常接触的**Louvain算法**，在大数据下很容易形成**怪物社区**，在业务中较少用到。

#### 5. GNN在设备网络的应用

![image-20210823105640523](D:\笔记\案例总结\微信基于图计算的反欺诈.assets\image-20210823105640523.png)

- 用户-设备网络: 

  - 支付各种风控场景中：交易欺诈，恶意账号识别，用户-设备二分网络应用效果也是非常好的
  - 需要降噪， 对边及节点的降噪， 剔除山寨机等有噪音节点

- 图神经网络算法两种

  1. random walk: e.g. node2vec
  2. neighborhood aggregation： e.g. GAT, Graphsage

  - 使用graph embedding拼接原有画像特征

  > 图神经网络算法一般分为两种，一种是random walk ，比如大名鼎鼎的node2vec，另一种是neighborhood aggregation 比如GAT，Graphsage，我们比较推荐使用邻居汇聚这种算法，因为有监督的学习我们比较好把握优化的方向。举个例子，下面这个图有1到8个点，5，6是标注的异常的点（因为图计算都是半监督学习，所以我们也需要做一定的标注），然后1，2这两个点跟他们是多跳关系，可以去掉，这就是做了一步降噪。我们跑图算法，最终还是要把一个异构图变成一个同构图的，如上图，这个例子虽然只减少了2个节点，但生成同构图的边可能会少一半。通过实验对比，如果只用GNN来跑有监督学习的话，AUC是0.92，比XGBoost跑画像特征得到的0.93稍差，但如果把GNN学习到的个体Embedding拼接到原有的画像特征，再跑XGBoost，AUC会有大幅度提升至0.97，这也说明了网络结构特征能给原有的个体画像特征带来明显的增益。

#### 6. 图算法的探索与创新

![image-20210823110113666](D:\笔记\案例总结\微信基于图计算的反欺诈.assets\image-20210823110113666.png)

- 有向motif + 时序 
- self-training & joint-training

### QA

- 图是同质还是异质的？

  - 在微信支付来说，很多有用的图都是异构的，比如人和物，比如说用户和商户是一个异构关系，用户和设备在风控好用的网络，这也是异构的，但是在做算法的时候，会先把异构图变成同构图。

- 为什么异构图要转成同构图？

  > 因为异构图算法不好跑，甚至很多算法本身虽然可以接受异构图数据的输入，但是**内部他也需要转化成同构图**才能执行，比如说GNN，在跑GNN的时候需要把用户和设备转成用户和用户之间的连接，因为设备只是起到一个媒介的作用，关键是我们看用户和用户之间的关联。图的问题都是**半监督**的问题，相对于网络来说，我们只有很少量的样本，需要从这少量的标注样本中在网络中找到更多相似的样本。刚刚有朋友也问到了怎么做**样本增强**，我们其实也可以通过这种方法，去半监督学习，找到更多相似样本（有关系且预测概率相近），就能做到样本增强了。

- 反洗钱应用

  > 反洗钱方面有刚刚提到的资金盘，资金盘其实涉及到传销反洗钱，涉及到使用USDT，现在很多洗钱都是通过USDT去走，还会涉及到二维码、银行卡，我们这里的话会通过很多关系的数据，先建立一个纯度高的网络，然后用 WCC，就是不考虑方向的connected component, 得到一个个小团伙之后，再用角色识别算法区分它们的角色。比如说在一些虚拟币、租码跑分平台，是属于国家管控洗钱领域的，这些平台我们是有进行反洗钱打击的，把里面的号该封封了，该处置的号处置了，该上策略上策略，这就是反洗钱的其中一个应用。

- GNN降噪

  > A：图（参GNN在设备网络的应用ppt图）本来这个网络是有1到8的节点，但是不需要那么多，因为有一些点没有跟我们标注的样本节点产生直接的联系的话，是可以直接把它剔除的，这样的话整个网络纯度会高一些，有可能会牺牲一些召回率，但这个问题不大，因为我们做了一轮后有可能会得到更多的样本，得到更多的样本后再持续标注和分析可以得到更多新的样本。