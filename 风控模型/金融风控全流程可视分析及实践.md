## 金融风控全流程可视分析及实践

- 2022-02-07

- 李权博士 上海科技大学 助理教授、研究员

- **导读：**与电商、广告等场景的风控不同，金融风控涉及到钱的安全，决定了公司的营收甚至是公司的生命线。根据对数据不同层次的需求，金融风控需要数据分析、数据建模和数据联邦等技术的支撑。很荣幸在此和大家交流金融风控全流程相关的实践案例，本次分享的内容包括： 

  - 金融风控
  - 金融风控对数据及技术的需求
  - 金融风控全流程
  - 金融风控全流程可视分析案例
  - 总结

- **COMMENT: 槽点挺多** 

  - 1. AutoML不说局限，说的非常美好，诱惑业务人员提出不切实际需求 -> 似乎有万能的拖拉拽平台，不需要懂算法，所有人都能建模， 呵呵
  - 2. 交互式可解释不现实，每种解释方法有它的局限性，操作人员需要懂这部分算法，只是把一些三方库api封装一下变成一个更漂亮的页面意义何在？面向的操作对象本身需要懂算法， 必然懂coding。
  - 3. 模型监控更扯，这就是个一般的通用需求，而这个需求如果使用的是云上AI平台，大部分本身自带此功能
  - 4. 同理数据降维可视化，t-SNE是有使用条件的，并且一般实际中想要2-3维人肉眼可见分类差异及异常点的任务，极其稀有，这功能真的是相当不实际了

  [TOC]

  

### 1. 金融风控

- 金融风控和电商广告的风控场景不一样的地方在于，金融风控涉及到钱的安全，决定了公司的营收状况和生命线。如果一家公司的月份额非常高，假设违约率稍有上升，损失都是非常大的。如果我们通过风控的手段把违约率降低，那么坏账的情况就会有所缓解。

  目前金融领域有**传统金融、互联网金融和消费金融**。

  - **传统金融**：一般指国家四大传统金融机构，包括银行、信托、保险和证券；
  - **互联网金融**：通过互联网技术实现金融流通的金融活动，包括互联网理财公司、借贷公司、互联网支付公司等；
  - **消费金融**：能够提供消费类贷款的持牌的非银行类金融机构，比如某呗、某白条。

- 三种金融机构都可以通过风控的技术做到：

  - 减少因违约等产生的**坏账**；
  - 通过放贷促进消费，提高企业的利润。

- 风控也有一定的**缺点**：

  - **风险具有滞后性**：公司为了提高转化率，授信、申请、审核等环节一般都是实时的，但用户借款之后至少要一段时间才知道是否违约，很多用户甚至在半年甚至一年之后才有违约行为。

  - **业务性非常复杂：**

    \- 风控数据源是非常丰富的，可以从各个领域各个方面都收集到大量**多元异构的数据**。

    \- 正负样本数据是非常**不均衡**的，违约的人是极少数的一部分人。

    \- 因为风控是**面向业务人员**，**最终的模型决策都需要让风控业务人员清楚**，所以需要较强的可解释性。

- 在金融风控里，我们通常把管理风控划成**贷前管理**、**贷中管理**和**贷后管理**3个阶段。常见的金融业务包括账户管理、理财产品等，其中风险控制都是非常重要的，例如对于信用评级、反欺诈、反洗钱等都具有非常重要的战略意义。

  我们今天主要提倡并且推动**可视分析技术**在金融风控领域的落地。通过**让机器和模型通过与业务专家进行交互**，**充分学习到人的先进的风险管理的经验，并且帮助他们进行决策**，提供更系统化、更全面化的视图。

![图片](%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456022063942-164456022192444.webp)

### 2. 金融风控对数据及技术的需求

- 我们根据人们不同层次的数据需求的划分，可以从**最上层的需要金融机构内部的数据**进行**分析**，到需要**金融机构内部的数据**进行**建模和预测**，到需要**外部的行研数据进行参考**，到最后需要**外部的隐私数据**做进一步的**建模**。
- ![图片](%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456051371145-164456051527347.webp)根据对数据不同层次的需求，有相应的技术来支撑。例如用交互式的可视分析，交互式的机器建模和可解释性，以及基于隐私保护的数据建模（联邦学习)技术等等。

#### 2.1 智能数据可视分析

- ![图片](%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456062786251-164456063007553.webp)

- 在智能数据可视分析方面，可以通过人工智能技术自动分析用户提供的金融数据，对金融机构的全表进行统计、特征的识别、字段间关系的识别，可以提供最初始化的数据和分析的意图。人工智能技术可以自动推荐合适的可视化图表和表达方式，可以拖拽相应的字段生成可视化图表给业务人员，并且可以参考分析目的和目标用户自动生成报表，进行互联互动。

  这也是我们发表在ACM IUI的一篇工作。通过智能数据可视分析技术，可以把复杂的金融数据快速地图表化、格式化出来，业务人员可以很快从中受益。

#### 2.2 交互式机器学习建模

- **comment**： **又一个误导业务人员， 诱惑他们提出不切实际需求的宣传， 咋不写写你autoML能做哪些层次的自动化搜索嘞？NAS又搜索了哪些结构？自动特征构建有什么要求？？？要花多长时间搜索？？？一般的业务人员能懂你这些流程么， 又不可能一键生成ML全套流水线，最后就变成了一个LR的超简易自动化脚本，业务人员唯一能懂的模型** 

- 在交互式机器学习机器学习建模方面，通过以人为中心的交互式操作，可以大大降低业务人员的建模成本。不需要编底层建模代码，也可以快速实现风险模型，高效地将专家的知识融合到风险模型当中。

- 右图是AutoML自动化机器学建模，它可以充分探索不同的机器学习模型以及同一机器学习模型下不同的分支，减少建模人员重复性的劳动，让建模的业务人员更加专注于挖掘数据本身。而且通过可视化告诉用户为什么AutoML选择了某个模型、哪些parameter更好、哪些超参更适合这个数据集，可以通过交互式机器学习建模以及自动化机器学习建模，让他们更加专注于业务知识。

- **(1) 模型解释**

  通过模型的解释，可以增加业务人员对模型运行逻辑的理解，增加模型的透明度。并且可以降低由于模型带来的不确定性，通过可解释性的机器学习技术，例如SHAP value、PDP、ICE、feature importance等技术去实现风险模型的全局解释和局部解释。

  - 全局解释，是对模型总体上表现的解释；
  - 局部解释，是对某些特别的样本做出解释，例如为什么不给某特定的人去放贷是因为某些特征没有达到要求等。

  并且可以通过交互式的分析，让不同的解释结果进行串联。

  **(2) 模型监控**

  很多模型是基于历史数据建模，但是线上会源源不断地产生新的数据，我们需要定期去评估模型。可能会由于数据分布的不一致、数据概念的迁移等，导致已经建好的模型失效，因此AutoML就不太适合应用在线上，需要去定期做线上建模的更新，对模型做监控。

  这是关于交互式机器学习建模这一方面的做的工作。

#### 2.3 覆盖金融风控相关数据的联邦学习及建模

- 数据联邦技术主要是用来解决不同数据源之间没有办法共享数据的问题。

  传统获取数据的方法有很多，例如：

  - 直接从第三方机构购买，但这种行为可能涉嫌违法；
  - 使用脱敏后的数据，会导致信息量下降，进而导致效果不是很好；
  - 如果直接把大家的建模结果放在一起，是有风险的。

- 在现在监管严格的情况下，强调数据隐私保护的重要性，两家机构是不可能直接进行数据共享，即使在同一企业集团内部的各个子板块之间也不愿意把自己的核心的业务数据放到数据中台做交换。

- 同时法律法规也出台了一些条款，强调数据隐私保护的重要性。

- 联邦学习技术主要分为两种（严格来说是3种）：横向联邦学习和纵向联邦学习。

  - **横向联邦**指两方在样本特征重叠多，样本空间互补；
  - **纵向联邦**指两方在样本空间重叠多，特征空间互补。

### 3. 金融风控全流程

#### 3.1 贷前可视化

<img src="%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456187801154.webp" alt="图片" style="zoom:50%;" />

- 贷前可视化最常见的是交互式的。每个银行都需要机器学习的建模平台，特别是用于信用评分建模这一关键环节。这里主要分享使用机器学习建模快速实现**评分模型可视化**的尝试。

- 银行业机器学习建模的特点是：数据类型多、数据量大，关注风险模型的鲁棒性和健壮性，需要融合专家知识到建模分析的闭环里面，需要进行**模型风险管理(MRM)**来满足监管的需求。

- 常见的交互式机器学习建模包括数据处理、特征工程、模型训练/预测、评估、模型解释和底层架构。

  今天的分享主要是三个方面：模型的训练过程、模型的解释性、数据探索。

#### 3.2 模型训练的可视化：决策树

<img src="%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456198398057.webp" alt="图片" style="zoom: 80%;" />

- 决策树是风控建模时常用的算法，它具有良好的可解释性。对于银行风控来说可解释性是非常重要的。交互技术可以让风控人员自由地操作决策树。不仅可以展示每个节点的详细信息，包括样本的数量、预测目标的准确率等基本信息，还可以由**用户交互式地操作，直接拆分节点，通过展示不同的特征的效用值**来给用户提供节点拆分的建议，可以方便地让用户将以往的经验融入到决策树模型当中。

#### 3.3 模型训练可视化： AutoML

为了提高用户训练模型工作效率，也提供自动机器学习建模。AutoML用得比较多，但是诟病比较多的是可解释性比较弱。自动机器学习技术能够给出比较好的模型，但是往往使用者需要想知道为什么选择了这个模型，或者说模型的哪个分支最终打败了其他的模型等决策的考虑。

- 我们提供了AutoML**基本训练过程的信息**可视化，包括全局进度的信息，例如AutoML进程、模型评估指标、特征重要性排序等，可以让用户直观地了解目前哪些特征是比较重要的、哪些算法表现得更好。

- 超参可视化：因为用户需要知道模型为什么做出这样的决策，所以希望模型是透明的且容易理解的，而不是黑箱模式。我们有必要让用户知道AutoML是如何挑选模型的，把AutoML的黑盒打开，对每一种算法展示各个分支的统计信息。例如，对于决策树，可以根据分裂准则，把它分为几个分支，对于决策树的不同的参数，可以通过散点图的方式可视化，用户就可以知道对于算法来说，哪个分支、哪些参数会使得模型表现更好，这样将整个训练过程和决策过程可视化，可以让用户使用更加透明。

- 进程控制 & 搜索空间剪枝： 用户可以随时停止AutoML的训练，也可以返回去修改AutoML的参数设置。如果发现某个算法效果不好，可以直接把这个算法的分支给终止掉，就相当于用户可以指定让AutoML去搜索某个空间，从而训练出一个比较好的模型。

以上是基于自动机器学习建模做的一些工作。

#### 3.4 模型训练可视化： SHAP

![图片](%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456223537959-164456223765261.webp)

#### 3.5 模型训练可视化： PDP& ICE

#### 3.6 数据交互式探索

- **comment： i.e降维可视化， 但是想要看出哪些是坏样本？数据分布差异？认真的么？如果分类任务这么简单，大概也不会有现在信贷风控这么多坑了吧...**
- t-SNE是很好的数据降维可视化的方法，所以也加入了这个技术在风控场景中使用。可以将模型训练样本与线上监控集样本同时展示，对比两个数据集之间分布的差异。
- 但是这个数据往往是高维的，用户在高维空间进行探索是相对困难的。通过高维数据降维的方法，将数据降到二维空间，并且尽量地保证高维数据之间的分布的差异没有在二维空间被损失得很厉害。同时可以看出模型的训练数据和结果数据分布的差异。
- **对于风控人员而言，更多的是需要看出哪些是“坏样本”**。

#### 3.7 贷中可视化

![图片](%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456256279562-164456256451864.webp)

- 贷中可视化比较像监控系统，可以借助预警及时地发现风险，需要比较完善的监控机制，进行应急处理。

- **comment：** 
- **这不像实际项目中的总结啊**， 贷中的话，一般没有流量暴增这一说，它和电商线上流量以及贷前业务不同，样本已经过一次贷前审核且时间间隔并不短(至少at天级)，训练数量完全可控。客群分布那里也很诡异，流量分发算法突然变更这件事发生概率很小，因为通常有容灾备份以及弹性负载均衡，这事落不到贷中监控啊， 就算发生，由于贷中模型并不是实时、准实时系统，即时红线几个小时，潜在损失那里也说不通。同理软硬件突发故障，有风险但这些可视化不是业务相关可视化啊，通常是底层Paas的监控及告警来管理哇。
- 骗贷应该在贷前模型发现，而不是贷中监控就能看到的吧？

#### 3.8 贷后可视化

![图片](%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456305258265-164456305393567-164456309599468.webp)

- 贷后可视化主要是策略的制定，可以根据客户群去制定不同的策略，所以是根据策略做监控、分析和优化，例如研发更好的客户分群，当有突发风险时做更快的解决方案等。

### 4. 案例

#### 4.1  贷后风险分析及同业机构评级

![图片](%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456320555771-164456320681173.webp)第一个是关于**贷后分析**。贷后需要做风险评估，对贷后数据可以计算分析用户的违约率和迁徙率的变化，但传统的方法需要业务人员花费非常多的时间人工做校验。我们从不同的维度分析贷后数据指标，做用户画像的交叉分析，同时可以刻画某行业或地区与违约的关联关系。

第二个是**银行同业机构评级**。传统的同业机构分档也是依赖人工的经验做调整，往往需要消耗大量的时间，特别是需要人工对比非常多的维度，容易漏掉关键的信息，导致评级结果不准确。所以也可以通过人工智能技术对同业指标进行推算分析之后，去挖掘中间的关联关系，进行同业机构的自动的分档和排名，并且提供可解释性。偏离较大的指标和监管的红线指标都可以同时的被可视化出来，为同业授信提供自动的预警。

这是一篇发在IEEE VIS 2021 的一篇关于同业机构评级方面的文章：https://arxiv.org/pdf/2108.03011.pdf

#### 4.2 企业内控

![图片](%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456324043874-164456324153676.webp)

金融风控广义上也包括企业内部的风险控制。根据企业内部能用的数据源，例如可以通过处理分析企业内部员工的酒店预定数据，如员工出差、订机票、订酒店，下班回家打车报销发票等数据，可以用来**检测违规操作异常事件**。也可以刻画**不同部门的用户画像**，还可以针对每个部门做整体的预算预测和协议酒店、协议机票等数据控制。

我们相关的工作包括：

- 帮助企业内部交通报销发票做**可视分析和异常检测**，看哪些报销单是有问题的。
- 用员工的打车数据，去调整企业的通勤班车的情况。大企业班车是有固定的路线的，但这个路线的制定往往是基于调研的方式，缺乏实时性和有效性。很多员工的住址会发生变化，而这些变化最直观的体现在他们的下班之后打车发票的终点。通过这些数据可以做到比较及时地对班车路线做全局的规划和调整。

 这是两篇发表在EuroVIS和IEEE VIS的文章。

#### 4.3 基于大数据隐私保护技术的联邦学习运行过程探查(重)

![图片](%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E5%85%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%9E%E8%B7%B5.assets/640-164456448918677-164456449024779.webp)

- 最后讲一下基于大数据隐私保护的**联邦学习的运行过程**。

- 在实践过程中用的比较多的是横向联邦和纵向联邦。对于联邦学习的运行过程，也是需要探查的。例如在**横向联邦**的时候，会有**初始化的模型**，从服务器发到每个客户端，每个客户再用自己的数据去训练和优化这个模型。经过若干次迭代之后，各个参与方可以把更新后的模型参数加密发回到服务器，**参数聚合到一起**，就形成全局的联合模型，模型再发回到各个参与方，以上整个过程是一轮通讯，一直到模型收敛，横向联邦训练结束。

- 金融风控用联邦学习的过程中会遇到一些问题，例如：

  - 第一，联邦学习能用的信息非常少，在隐私保护的前提下，只能用有限的数据去了解横向联邦学习的运行过程，因此就需要帮用户去探查运行过程。

  - 第二，用户需要知道各个参与方的相关信息，例如某个参与方突然掉线，或者数据不达标、有异常等，都会对全局模型有影响。

  - 最后，需要去评价各个参与方对联邦模型的贡献度。

这也是今年发表在TVCG的一篇工作：https://ieeexplore.ieee.org/document/9408377

### QA

Q1：**交互式建模**部分是用的哪种开源框架？

A：这个是之前在公司做的，不是开源的方式，是自己去开发的，用**QT**这些典型的客户端的界面，底层是**大数据的平台**，比如hadoop、hbase，基于这些**封装各种机器学习的模型**，去做了一套针对银行金融机构场景下的交互式机器学习建模。

所以它的过程是非常针对金融银行场景下的，因为它做了版本之后，是**马上要投入到风险部门去做实际的case study 或者user study**之后去，收集一定的反馈，做快速的迭代。所以它应用得非常多的场景是风控场景，金融产品的场景，也是特别针对银行场景做的尝试，也是之前经验的沉淀，例如他可能对模型解释监控，还有可视化的数据探索方面依赖是比较重的。

还有交互式机器学习建模，很多业务人员他不会写代码，或者说他只会写SAS代码。他最希望的交互方式是拖拽，在这个基础上之后就加入了AutoML。就相当于他下班之前可以跑一下AutoML算法，平台把它跑完之后，直接告诉他哪个模型是最好的。

Q2：联邦学习对不同数据传输时**信息标准一致性**如何操作？

A：目前做的系统是有点像实验室的原型，这个原型并没有考虑太多的底层工程上的问题。例如，某些参与方训练得早，就可能会传一些参数过来，另外参与方可能训练地晚，传过来就比较慢。也是说给了最长的default session，在这个时间只要它能够把gradient或参数给传到server做聚合，就觉得它是OK的，否则就觉得它可能会由于网络问题导致模型参数没有更新上来。通过以上去规避了这么一种现实情况下可能需要严肃考虑的问题。

Q3：对于大流量数据传输性不高，如何解决？

A：这个也是工程上的问题。因为传过来的并不是数据，联邦学习传过来都是梯度方面的参数，所以它数据量并不是很大，它数据量大的都是它的数据本身，但数据本身是不会出本地的，基本是在各个参与方自己的local space做training，training之后模型参数才会传到server端，所以这方面可能理解上可能会有这么一个问题。

